drop trigger if exists "claimed_boost_insert_trigger" on "public"."claimed_boost";

revoke delete on table "public"."badge_configuration" from "anon";

revoke insert on table "public"."badge_configuration" from "anon";

revoke references on table "public"."badge_configuration" from "anon";

revoke select on table "public"."badge_configuration" from "anon";

revoke trigger on table "public"."badge_configuration" from "anon";

revoke truncate on table "public"."badge_configuration" from "anon";

revoke update on table "public"."badge_configuration" from "anon";

revoke delete on table "public"."badge_configuration" from "authenticated";

revoke insert on table "public"."badge_configuration" from "authenticated";

revoke references on table "public"."badge_configuration" from "authenticated";

revoke select on table "public"."badge_configuration" from "authenticated";

revoke trigger on table "public"."badge_configuration" from "authenticated";

revoke truncate on table "public"."badge_configuration" from "authenticated";

revoke update on table "public"."badge_configuration" from "authenticated";

revoke delete on table "public"."badge_configuration" from "service_role";

revoke insert on table "public"."badge_configuration" from "service_role";

revoke references on table "public"."badge_configuration" from "service_role";

revoke select on table "public"."badge_configuration" from "service_role";

revoke trigger on table "public"."badge_configuration" from "service_role";

revoke truncate on table "public"."badge_configuration" from "service_role";

revoke update on table "public"."badge_configuration" from "service_role";

revoke delete on table "public"."boost_configuration" from "anon";

revoke insert on table "public"."boost_configuration" from "anon";

revoke references on table "public"."boost_configuration" from "anon";

revoke select on table "public"."boost_configuration" from "anon";

revoke trigger on table "public"."boost_configuration" from "anon";

revoke truncate on table "public"."boost_configuration" from "anon";

revoke update on table "public"."boost_configuration" from "anon";

revoke delete on table "public"."boost_configuration" from "authenticated";

revoke insert on table "public"."boost_configuration" from "authenticated";

revoke references on table "public"."boost_configuration" from "authenticated";

revoke select on table "public"."boost_configuration" from "authenticated";

revoke trigger on table "public"."boost_configuration" from "authenticated";

revoke truncate on table "public"."boost_configuration" from "authenticated";

revoke update on table "public"."boost_configuration" from "authenticated";

revoke delete on table "public"."boost_configuration" from "service_role";

revoke insert on table "public"."boost_configuration" from "service_role";

revoke references on table "public"."boost_configuration" from "service_role";

revoke select on table "public"."boost_configuration" from "service_role";

revoke trigger on table "public"."boost_configuration" from "service_role";

revoke truncate on table "public"."boost_configuration" from "service_role";

revoke update on table "public"."boost_configuration" from "service_role";

revoke delete on table "public"."claimed_boost" from "anon";

revoke insert on table "public"."claimed_boost" from "anon";

revoke references on table "public"."claimed_boost" from "anon";

revoke select on table "public"."claimed_boost" from "anon";

revoke trigger on table "public"."claimed_boost" from "anon";

revoke truncate on table "public"."claimed_boost" from "anon";

revoke update on table "public"."claimed_boost" from "anon";

revoke delete on table "public"."claimed_boost" from "authenticated";

revoke insert on table "public"."claimed_boost" from "authenticated";

revoke references on table "public"."claimed_boost" from "authenticated";

revoke select on table "public"."claimed_boost" from "authenticated";

revoke trigger on table "public"."claimed_boost" from "authenticated";

revoke truncate on table "public"."claimed_boost" from "authenticated";

revoke update on table "public"."claimed_boost" from "authenticated";

revoke delete on table "public"."claimed_boost" from "service_role";

revoke insert on table "public"."claimed_boost" from "service_role";

revoke references on table "public"."claimed_boost" from "service_role";

revoke select on table "public"."claimed_boost" from "service_role";

revoke trigger on table "public"."claimed_boost" from "service_role";

revoke truncate on table "public"."claimed_boost" from "service_role";

revoke update on table "public"."claimed_boost" from "service_role";

revoke delete on table "public"."guild_win" from "anon";

revoke insert on table "public"."guild_win" from "anon";

revoke references on table "public"."guild_win" from "anon";

revoke select on table "public"."guild_win" from "anon";

revoke trigger on table "public"."guild_win" from "anon";

revoke truncate on table "public"."guild_win" from "anon";

revoke update on table "public"."guild_win" from "anon";

revoke delete on table "public"."guild_win" from "authenticated";

revoke insert on table "public"."guild_win" from "authenticated";

revoke references on table "public"."guild_win" from "authenticated";

revoke select on table "public"."guild_win" from "authenticated";

revoke trigger on table "public"."guild_win" from "authenticated";

revoke truncate on table "public"."guild_win" from "authenticated";

revoke update on table "public"."guild_win" from "authenticated";

revoke delete on table "public"."guild_win" from "service_role";

revoke insert on table "public"."guild_win" from "service_role";

revoke references on table "public"."guild_win" from "service_role";

revoke select on table "public"."guild_win" from "service_role";

revoke trigger on table "public"."guild_win" from "service_role";

revoke truncate on table "public"."guild_win" from "service_role";

revoke update on table "public"."guild_win" from "service_role";

revoke delete on table "public"."treasure_box_configuration" from "anon";

revoke insert on table "public"."treasure_box_configuration" from "anon";

revoke references on table "public"."treasure_box_configuration" from "anon";

revoke select on table "public"."treasure_box_configuration" from "anon";

revoke trigger on table "public"."treasure_box_configuration" from "anon";

revoke truncate on table "public"."treasure_box_configuration" from "anon";

revoke update on table "public"."treasure_box_configuration" from "anon";

revoke delete on table "public"."treasure_box_configuration" from "authenticated";

revoke insert on table "public"."treasure_box_configuration" from "authenticated";

revoke references on table "public"."treasure_box_configuration" from "authenticated";

revoke select on table "public"."treasure_box_configuration" from "authenticated";

revoke trigger on table "public"."treasure_box_configuration" from "authenticated";

revoke truncate on table "public"."treasure_box_configuration" from "authenticated";

revoke update on table "public"."treasure_box_configuration" from "authenticated";

revoke delete on table "public"."treasure_box_configuration" from "service_role";

revoke insert on table "public"."treasure_box_configuration" from "service_role";

revoke references on table "public"."treasure_box_configuration" from "service_role";

revoke select on table "public"."treasure_box_configuration" from "service_role";

revoke trigger on table "public"."treasure_box_configuration" from "service_role";

revoke truncate on table "public"."treasure_box_configuration" from "service_role";

revoke update on table "public"."treasure_box_configuration" from "service_role";

revoke delete on table "public"."treasure_box_entries" from "anon";

revoke insert on table "public"."treasure_box_entries" from "anon";

revoke references on table "public"."treasure_box_entries" from "anon";

revoke select on table "public"."treasure_box_entries" from "anon";

revoke trigger on table "public"."treasure_box_entries" from "anon";

revoke truncate on table "public"."treasure_box_entries" from "anon";

revoke update on table "public"."treasure_box_entries" from "anon";

revoke delete on table "public"."treasure_box_entries" from "authenticated";

revoke insert on table "public"."treasure_box_entries" from "authenticated";

revoke references on table "public"."treasure_box_entries" from "authenticated";

revoke select on table "public"."treasure_box_entries" from "authenticated";

revoke trigger on table "public"."treasure_box_entries" from "authenticated";

revoke truncate on table "public"."treasure_box_entries" from "authenticated";

revoke update on table "public"."treasure_box_entries" from "authenticated";

revoke delete on table "public"."treasure_box_entries" from "service_role";

revoke insert on table "public"."treasure_box_entries" from "service_role";

revoke references on table "public"."treasure_box_entries" from "service_role";

revoke select on table "public"."treasure_box_entries" from "service_role";

revoke trigger on table "public"."treasure_box_entries" from "service_role";

revoke truncate on table "public"."treasure_box_entries" from "service_role";

revoke update on table "public"."treasure_box_entries" from "service_role";

revoke delete on table "public"."treasure_box_state" from "anon";

revoke insert on table "public"."treasure_box_state" from "anon";

revoke references on table "public"."treasure_box_state" from "anon";

revoke select on table "public"."treasure_box_state" from "anon";

revoke trigger on table "public"."treasure_box_state" from "anon";

revoke truncate on table "public"."treasure_box_state" from "anon";

revoke update on table "public"."treasure_box_state" from "anon";

revoke delete on table "public"."treasure_box_state" from "authenticated";

revoke insert on table "public"."treasure_box_state" from "authenticated";

revoke references on table "public"."treasure_box_state" from "authenticated";

revoke select on table "public"."treasure_box_state" from "authenticated";

revoke trigger on table "public"."treasure_box_state" from "authenticated";

revoke truncate on table "public"."treasure_box_state" from "authenticated";

revoke update on table "public"."treasure_box_state" from "authenticated";

revoke delete on table "public"."treasure_box_state" from "service_role";

revoke insert on table "public"."treasure_box_state" from "service_role";

revoke references on table "public"."treasure_box_state" from "service_role";

revoke select on table "public"."treasure_box_state" from "service_role";

revoke trigger on table "public"."treasure_box_state" from "service_role";

revoke truncate on table "public"."treasure_box_state" from "service_role";

revoke update on table "public"."treasure_box_state" from "service_role";

revoke delete on table "public"."user_address_unique_challenge_status" from "anon";

revoke insert on table "public"."user_address_unique_challenge_status" from "anon";

revoke references on table "public"."user_address_unique_challenge_status" from "anon";

revoke select on table "public"."user_address_unique_challenge_status" from "anon";

revoke trigger on table "public"."user_address_unique_challenge_status" from "anon";

revoke truncate on table "public"."user_address_unique_challenge_status" from "anon";

revoke update on table "public"."user_address_unique_challenge_status" from "anon";

revoke delete on table "public"."user_address_unique_challenge_status" from "authenticated";

revoke insert on table "public"."user_address_unique_challenge_status" from "authenticated";

revoke references on table "public"."user_address_unique_challenge_status" from "authenticated";

revoke select on table "public"."user_address_unique_challenge_status" from "authenticated";

revoke trigger on table "public"."user_address_unique_challenge_status" from "authenticated";

revoke truncate on table "public"."user_address_unique_challenge_status" from "authenticated";

revoke update on table "public"."user_address_unique_challenge_status" from "authenticated";

revoke delete on table "public"."user_address_unique_challenge_status" from "service_role";

revoke insert on table "public"."user_address_unique_challenge_status" from "service_role";

revoke references on table "public"."user_address_unique_challenge_status" from "service_role";

revoke select on table "public"."user_address_unique_challenge_status" from "service_role";

revoke trigger on table "public"."user_address_unique_challenge_status" from "service_role";

revoke truncate on table "public"."user_address_unique_challenge_status" from "service_role";

revoke update on table "public"."user_address_unique_challenge_status" from "service_role";

revoke delete on table "public"."user_guild_score_claim" from "anon";

revoke insert on table "public"."user_guild_score_claim" from "anon";

revoke references on table "public"."user_guild_score_claim" from "anon";

revoke select on table "public"."user_guild_score_claim" from "anon";

revoke trigger on table "public"."user_guild_score_claim" from "anon";

revoke truncate on table "public"."user_guild_score_claim" from "anon";

revoke update on table "public"."user_guild_score_claim" from "anon";

revoke delete on table "public"."user_guild_score_claim" from "authenticated";

revoke insert on table "public"."user_guild_score_claim" from "authenticated";

revoke references on table "public"."user_guild_score_claim" from "authenticated";

revoke select on table "public"."user_guild_score_claim" from "authenticated";

revoke trigger on table "public"."user_guild_score_claim" from "authenticated";

revoke truncate on table "public"."user_guild_score_claim" from "authenticated";

revoke update on table "public"."user_guild_score_claim" from "authenticated";

revoke delete on table "public"."user_guild_score_claim" from "service_role";

revoke insert on table "public"."user_guild_score_claim" from "service_role";

revoke references on table "public"."user_guild_score_claim" from "service_role";

revoke select on table "public"."user_guild_score_claim" from "service_role";

revoke trigger on table "public"."user_guild_score_claim" from "service_role";

revoke truncate on table "public"."user_guild_score_claim" from "service_role";

revoke update on table "public"."user_guild_score_claim" from "service_role";

alter table "public"."claimed_boost" drop constraint "claimed_boost_boost_id_fkey";

drop function if exists "public"."guilduserclaim"(_game_id bigint, _user_address text);

drop function if exists "public"."guildwinshares"(_game_id bigint);

drop function if exists "public"."upserttreasurebox"(_game_id bigint, _user_address text, _cbid text, _ens_name text, _increment bigint, _tap_count integer);

drop function if exists "public"."user_claim_guild_score"(_game_id bigint, _user_address text);

alter table "public"."badge_configuration" drop constraint "badge_configuration_pkey";

alter table "public"."boost_configuration" drop constraint "boost_configuration_pkey";

alter table "public"."claimed_boost" drop constraint "claimed_boost_pkey";

alter table "public"."guild_win" drop constraint "guild_win_pkey";

alter table "public"."treasure_box_configuration" drop constraint "treasurebox_configuration_pkey";

alter table "public"."treasure_box_entries" drop constraint "treasurebox_attacks_pkey";

alter table "public"."treasure_box_state" drop constraint "treasure_box_state_pkey";

alter table "public"."user_address_unique_challenge_status" drop constraint "user_address_unique_challenge_status_pkey";

alter table "public"."user_guild_score_claim" drop constraint "user_guild_score_claim_pkey";

drop index if exists "public"."badge_configuration_pkey";

drop index if exists "public"."boost_configuration_pkey";

drop index if exists "public"."claimed_boost_boost_id_user_address_idx";

drop index if exists "public"."claimed_boost_pkey";

drop index if exists "public"."claimed_boost_unique";

drop index if exists "public"."guild_win_game_id_claim_id_idx";

drop index if exists "public"."guild_win_pkey";

drop index if exists "public"."treasure_box_entries_unique";

drop index if exists "public"."treasure_box_state_pkey";

drop index if exists "public"."treasure_box_state_unique";

drop index if exists "public"."treasurebox_attacks_pkey";

drop index if exists "public"."treasurebox_configuration_pkey";

drop index if exists "public"."user_address_unique_challenge_status_game_id_challenge_uid_idx";

drop index if exists "public"."user_address_unique_challenge_status_game_id_user_address_idx";

drop index if exists "public"."user_address_unique_challenge_status_pkey";

drop index if exists "public"."user_guild_score_claim_game_id_guild_id_user_address_claim__idx";

drop index if exists "public"."user_guild_score_claim_pkey";

drop table "public"."badge_configuration";

drop table "public"."boost_configuration";

drop table "public"."claimed_boost";

drop table "public"."guild_win";

drop table "public"."treasure_box_configuration";

drop table "public"."treasure_box_entries";

drop table "public"."treasure_box_state";

drop table "public"."user_address_unique_challenge_status";

drop table "public"."user_guild_score_claim";

alter table "public"."challenge_configuration" drop column "auto_claim";

alter table "public"."challenge_configuration" drop column "end_timestamp";

alter table "public"."challenge_configuration" drop column "is_dynamic_points";

alter table "public"."challenge_configuration" drop column "start_timestamp";

alter table "public"."challenge_configuration" add column "challenge_id" text not null default '""'::text;

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.getbadgestate(_game_id bigint, _user_address text)
 RETURNS TABLE(j json)
 LANGUAGE plpgsql
AS $function$
declare 

begin
 RETURN QUERY select to_json(temp) from (select b.id,b.name,b.image_url,b.contract_address,b.token_id,b.cta_url,b.cta_text,b.type,b.lat_lng,b.description,b.artist_name,w.to_address,w.transaction_hash,w.created_at,w.event_type from badge_configuration as b LEFT join webhook_data as w
  on LOWER(b.contract_address) = LOWER(w.contract_address) and b.token_id::bigint = w.value and LOWER(w.from_address) = LOWER(b.minter)
  and w.to_address ILIKE _user_address where b.game_id = _game_id) as temp;
end; 
$function$
;

CREATE OR REPLACE FUNCTION public.user_challenge_status_accumulate_v2()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$declare 
  _sum_challenge_points bigint = 0;
  _sum_guild_points bigint =0;
begin
  SELECT COALESCE(SUM(ucs.points), 0) INTO _sum_challenge_points
FROM user_challenge_status AS ucs
WHERE ucs.user_address = NEW.user_address AND ucs.game_id = NEW.game_id;

UPDATE score
SET current_score = _sum_challenge_points, updated_at = NOW()
WHERE user_address = NEW.user_address AND game_id = NEW.game_id;

IF NOT FOUND THEN 
    INSERT INTO score(current_score, user_address, game_id)
    VALUES (_sum_challenge_points, NEW.user_address, NEW.game_id);
END IF;

RETURN NEW;
end;$function$
;

CREATE OR REPLACE FUNCTION public.webhook_data_update()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$ 
    
    
    DECLARE 
      _num_nfts BIGINT;
      _game_id BIGINT;
    BEGIN 
        --SELECT count(*)+1 into _num_nfts from webhook_data where to_address = NEW.to_address;
        select ag.game_id into _game_id from badge_configuration as b join address_gameid_configuration as ag on b.contract_address = ag.address 
        WHERE b.contract_address = NEW.contract_address and b.token_id::bigint = NEW.value and b.minter = NEW.from_address
        and b.type != 'level';
        IF FOUND THEN
          SELECT count(*)+1 into _num_nfts from webhook_data where to_address = NEW.to_address;
          INSERT into claimed_boost(boost_id,user_address,game_id)
          SELECT b.id as boost_id,NEW.to_address as user_address,_game_id as game_id
          FROM boost_configuration AS b
          LEFT JOIN claimed_boost AS c ON b.id = c.boost_id AND c.user_address = NEW.to_address
          WHERE b.boost_type = 'TRANSFER_NFT' 
          and b.game_id = _game_id
          AND c.boost_id IS NULL
          AND b.nft_amount <= _num_nfts 
          ON CONFLICT (boost_id,user_address,game_id)
          DO NOTHING;               
          RETURN NEW;
        END IF;
        RETURN NULL;
    END; 
    
    $function$
;


